<script>
  // Selecionando os elementos principais
  const decrementButton = document.getElementById("decrement");
  const incrementButton = document.getElementById("increment");
  const totalValueInput = document.getElementById("totalValue");
  const calculateButton = document.getElementById("calculateButton");
  const pixKeyDiv = document.getElementById("pixKey");
  const pixQrCode = document.getElementById("pixQrCode");
  const selectedTitlesDiv = document.getElementById("selectedTitles");
  const copyButton = document.getElementById('copy-pix-key-button');
  const cards = document.querySelectorAll('.card');

  let totalValue = parseFloat(totalValueInput.value) || 1;

  console.log("Valor total inicial:", totalValue);

  // Simulação de verificação de login (alterar conforme seu sistema de autenticação)
  let isLoggedIn = false; // Mudar para 'true' após login bem-sucedido

  // Atualiza o botão inicialmente
  updateButton();

  // Função para atualizar o botão com o valor correto
  function updateButton() {
    const pricePerNumber = 0.06;
    const totalAmount = (totalValue * pricePerNumber).toFixed(2);
    calculateButton.textContent = `Quero participar R$ ${totalAmount}`;
    console.log("Botão de calcular atualizado:", totalAmount);
  }

  // Adicionar evento de clique para os cards
  cards.forEach(card => {
    card.addEventListener('click', () => {
      console.log("Card clicado.");

      // Obter o valor do card clicado
      const selectedValue = parseFloat(card.getAttribute('data-value')) || 0;

      // Atualizar o valor total
      totalValue += selectedValue;
      totalValueInput.value = totalValue;
      updateButton();

      // Adicionar feedback visual
      cards.forEach(c => c.classList.remove('selected')); // Remover seleção de outros cards
      card.classList.add('selected'); // Adicionar classe ao card selecionado
    });
  });

  // Evento para decrementar o valor
  decrementButton.addEventListener("click", () => {
    console.log("Botão de decremento clicado.");
    if (totalValue > 1) {
      totalValue--;
      totalValueInput.value = totalValue;
      updateButton();
    }
  });

  // Evento para incrementar o valor
  incrementButton.addEventListener("click", () => {
    console.log("Botão de incremento clicado.");
    totalValue++;
    totalValueInput.value = totalValue;
    updateButton();
  });

  // Atualiza o valor do botão sempre que o valor do input mudar
  totalValueInput.addEventListener("input", () => {
    console.log("Valor do input alterado.");
    totalValue = parseFloat(totalValueInput.value) || 1;
    updateButton();
  });

  // Função para gerar os títulos
  function generateTitles(totalValue) {
    console.log("Gerando títulos...");
    const titles = [];
    for (let i = 1; i <= totalValue; i++) {
      let titleNumber = i.toString().padStart(7, "0");
      if (titleNumber === "0000009" || titleNumber === "0000010") {
        continue;
      }
      titles.push(`Título ${titleNumber}`);
    }
    console.log("Títulos gerados:", titles);
    return titles;
  }

  // Verificação de login e envio de requisição para gerar chave Pix
  calculateButton.addEventListener("click", async () => {
    console.log("Botão de calcular clicado.");

    if (!isLoggedIn) {
      alert("Você precisa fazer login para continuar.");
      return; // Impede a geração da chave Pix se não estiver logado
    }

    const pricePerNumber = 0.06;
    const totalAmount = (totalValue * pricePerNumber).toFixed(2);

    console.log("Total calculado para chave Pix:", totalAmount);

    try {
      console.log("Enviando requisição para gerar chave Pix...");
      const response = await fetch("https://wesleyalemaopremios-com-br.onrender.com/gerar-chave-pix", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ valor: parseFloat(totalAmount) }),
      });

      const data = await response.json();
      console.log("Resposta da geração da chave Pix:", data);

      if (data.txid && data.qrcode && data.imagemQrcode) {
        // Exibir a chave Pix
        pixKeyDiv.textContent = `${data.qrcode}`;

        // Exibir QR Code
        const qrCodeImage = document.createElement("img");
        qrCodeImage.src = data.imagemQrcode;
        qrCodeImage.alt = "QR Code Pix";
        pixQrCode.innerHTML = "";
        pixQrCode.appendChild(qrCodeImage);
        console.log("QR Code gerado com sucesso.");

        // Exibir o botão para copiar a chave Pix
        copyButton.style.display = "inline-block";
        console.log("Botão de copiar chave Pix exibido.");

        // Verificação do pagamento
        setInterval(async () => {
          console.log("Verificando pagamento...");
          try {
            const paymentStatusResponse = await fetch("https://wesleyalemaopremios-com-br.onrender.com/verificar-pagamento", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ txid: data.txid }),
            });

            const paymentStatusData = await paymentStatusResponse.json();
            console.log("Status do pagamento:", paymentStatusData);

            if (paymentStatusData.status === "CONFIRMED") {
              console.log("Pagamento confirmado!");
              const titles = generateTitles(totalValue);
              selectedTitlesDiv.innerHTML = `<h3>Títulos gerados:</h3><ul>${titles.map(title => `<li>${title}</li>`).join("")}</ul>`;
              selectedTitlesDiv.style.display = "block";
            } else {
              console.log("Pagamento não confirmado.");
            }
          } catch (error) {
            console.error("Erro ao verificar o pagamento:", error);
          }
        }, 5000);
      } else {
        console.log("Erro ao gerar chave Pix ou QR Code.");
        pixKeyDiv.textContent = "Erro ao gerar a chave Pix.";
      }
    } catch (error) {
      console.error("Erro ao conectar com o servidor:", error);
      pixKeyDiv.textContent = "Erro ao conectar com o servidor.";
    }
  });

  // Evento para copiar a chave Pix
  if (copyButton) {
    copyButton.addEventListener('click', function () {
      console.log("Botão de copiar clicado.");
      const pixKey = pixKeyDiv.textContent;
      navigator.clipboard.writeText(pixKey).then(function () {
        alert("Chave Pix copiada com sucesso!");
        console.log("Chave Pix copiada com sucesso.");
      }).catch(function (err) {
        console.error("Erro ao copiar a chave Pix:", err);
      });
    });
  }
</script>
