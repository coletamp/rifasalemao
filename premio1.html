<h2 class="centralizado">Selecione a quantidade de títulos</h2>
<!-- Cards Section -->
<div class="cards">
    <div class="card" data-value="34">    
        <div class="value">+34</div>
        <div class="label">SELECIONAR</div>
    </div>
    <div class="card popular" data-value="100">    
        <div class="value">+100</div>
        <div class="label">SELECIONAR</div>
    </div>
    <div class="card" data-value="150">    
        <div class="value">+150</div>
        <div class="label">SELECIONAR</div>
    </div>
    <div class="card" data-value="400">    
        <div class="value">+400</div>
        <div class="label">SELECIONAR</div>
    </div>
    <div class="card" data-value="800">    
        <div class="value">+800</div>
        <div class="label">SELECIONAR</div>
    </div>
    <div class="card" data-value="1000">    
        <div class="value">+1000</div>
        <div class="label">SELECIONAR</div>
    </div>
</div>    

<!-- Campo para somar o valor -->
<div class="footer-buttons">
    <!-- Adicionando o id "totalValue" no campo de entrada -->
      <button id="decrement">-</button>
        <input id="totalValue" type="number" value="5" min="1">
        <button id="increment">+</button>
    </div>
<button id="calculateButton">Quero participar R$ 2,37</button>
<div style="display: flex; justify-content: center; align-items: center; height: auto; padding: 20px 0; flex-direction: column;">
  <img 
    width="250" 
    height="250" 
    src="" 
    style="display: none;" 
    id="qrcodeImage"
  />
</div>
<div id="selectedTitles"></div>

<div id="pix-container">
  <div id="pix-box">
    <div id="pixKey" style="text-align: center; word-wrap: break-word; overflow-wrap: break-word; width: 100%; margin: 0 auto;"></div>
  </div><br>
  <button id="copy-pix-key-button" style="display:none;">Copiar chave Pix</button>
</div>

<div id="titulo-container" style="display:none;">
  <h3>Títulos Disponíveis:</h3>
  <ul id="titulo-list"></ul>
</div>

<script>
  const decrementButton = document.getElementById("decrement");
  const incrementButton = document.getElementById("increment");
  const totalValueInput = document.getElementById("totalValue");
  const calculateButton = document.getElementById("calculateButton");
  const pixKeyDiv = document.getElementById("pixKey");
  const selectedTitlesDiv = document.getElementById("selectedTitles");
  const copyButton = document.getElementById("copy-pix-key-button");
  const qrcodeImage = document.getElementById("qrcodeImage");

  let totalValue = parseFloat(totalValueInput?.value) || 1;

  function updateButton() {
    const pricePerNumber = 0.45;
    const totalAmount = (totalValue * pricePerNumber).toFixed(2);
    calculateButton.textContent = `Quero participar R$ ${totalAmount}`;
  }

  decrementButton?.addEventListener("click", () => {
    if (totalValue > 1) {
      totalValue--;
      totalValueInput.value = totalValue;
      updateButton();
    }
  });

  incrementButton?.addEventListener("click", () => {
    totalValue++;
    totalValueInput.value = totalValue;
    updateButton();
  });

  totalValueInput?.addEventListener("input", () => {
    totalValue = parseFloat(totalValueInput.value) || 1;
    updateButton();
  });

  // Adicionando funcionalidade aos cards
  const cards = document.querySelectorAll(".card");
  cards.forEach(card => {
    card.addEventListener("click", () => {
      const cardValue = parseInt(card.getAttribute("data-value"), 10);
      totalValue += cardValue;
      totalValueInput.value = totalValue;
      updateButton();
    });
  });

  function generateRandomTitles(quantity) {
    const titles = new Set();
    while (titles.size < quantity) {
      const randomNumber = Math.floor(Math.random() * 9999999) + 1;
      titles.add(randomNumber.toString().padStart(7, "0"));
    }
    return Array.from(titles);
  }

  calculateButton.addEventListener("click", async () => {
    const phone = localStorage.getItem("userPhone");
    if (!phone) {
      alert("Por favor, informe seu telefone antes de prosseguir.");
      return;
    }

    const pricePerNumber = 0.45;
    const totalAmount = (totalValue * pricePerNumber).toFixed(2);

    try {
      const response = await fetch("https://wesleyalemaopremios-com-br.onrender.com/gerar-chave-pix", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          valor: parseFloat(totalAmount),
          payerEmail: "usuario@exemplo.com",
          payerCpf: "12345678909",
        }),
      });

      const data = await response.json();
      if (data.txid && data.qrcode && data.copiaECola) {
        pixKeyDiv.textContent = data.qrcode;
        qrcodeImage.src = `data:image/jpeg;base64,${data.copiaECola}`;
        qrcodeImage.style.display = "block";
        copyButton.style.display = "inline-block";

        const paymentChecker = setInterval(async () => {
          try {
            const statusResponse = await fetch("https://wesleyalemaopremios-com-br.onrender.com/verificar-status", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ txid: data.txid }),
            });

            const statusData = await statusResponse.json();
            if (statusData.status === "approved") {
              clearInterval(paymentChecker);
              const titles = generateRandomTitles(totalValue);
              selectedTitlesDiv.innerHTML = `<h3>Títulos gerados:</h3><ul>${titles.filter(title => title !== "0000001" && title !== "0000002").map(title => `<li>${title}</li>`).join("")}</ul>`;
              pixKeyDiv.style.display = "none";
              copyButton.style.display = "none";
              qrcodeImage.style.display = "none";
            }
          } catch (error) {
            console.error("Erro ao verificar o pagamento:", error);
          }
        }, 5000);
      } else {
        pixKeyDiv.textContent = "Erro ao gerar a chave Pix.";
      }
    } catch (error) {
      console.error("Erro ao conectar com o servidor:", error);
      pixKeyDiv.textContent = "Erro ao conectar com o servidor.";
    }
  });

  copyButton?.addEventListener("click", () => {
    navigator.clipboard.writeText(pixKeyDiv.textContent).then(() => {
      alert("Chave Pix copiada com sucesso!");
    }).catch(err => {
      console.error("Erro ao copiar a chave Pix:", err);
    });
  });
</script>
